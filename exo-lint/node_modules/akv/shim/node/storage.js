/**
 * File system storage
 * @augments EventEmitter
 * @class Storage
 * @param {string} filename
 * @param {Object} data
 */
'use strict';

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var _require = require('events');

var EventEmitter = _require.EventEmitter;

var co = require('co');
var fs = require('fs');
var readFromFile = require('./file/read_from_file');
var writeToFile = require('./file/write_to_file');
var fileHash = require('./file/file_hash');

/** @lends Storage */

var Storage = function (_EventEmitter) {
  (0, _inherits3.default)(Storage, _EventEmitter);

  function Storage(filename) {
    (0, _classCallCheck3.default)(this, Storage);

    var _this = (0, _possibleConstructorReturn3.default)(this, (Storage.__proto__ || (0, _getPrototypeOf2.default)(Storage)).call(this));

    var s = _this;
    s.filename = filename;
    s.hash = null;
    s.memory = null;
    s.needsFlush = false;
    s._flushing = false;
    s._flushTimer = -1;
    return _this;
  }

  /**
   * Read data
   * @returns {Promise}
   */


  (0, _createClass3.default)(Storage, [{
    key: 'read',
    value: function read() {
      var s = this;
      var filename = s.filename;
      var memory = s.memory;

      return co(_regenerator2.default.mark(function _callee() {
        var hash, cached, data;
        return _regenerator2.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                _context.next = 2;
                return fileHash(filename);

              case 2:
                hash = _context.sent;
                cached = !hash || s.hash === hash;

                if (!cached) {
                  _context.next = 6;
                  break;
                }

                return _context.abrupt('return', memory);

              case 6:
                s.hash = hash;

                data = readFromFile(filename);

                s.memory = data;
                return _context.abrupt('return', data);

              case 10:
              case 'end':
                return _context.stop();
            }
          }
        }, _callee, this);
      }));
    }

    /**
     * Write data
     * @param data
     * @returns {*|Promise}
     */

  }, {
    key: 'write',
    value: function write(data) {
      var s = this;
      var filename = s.filename;

      return co(_regenerator2.default.mark(function _callee2() {
        return _regenerator2.default.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                s.memory = data;
                _context2.next = 3;
                return fileHash(filename);

              case 3:
                s.hash = _context2.sent;

                s.needsFlush = true;

              case 5:
              case 'end':
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));
    }

    /**
     * Save data into file system
     * @returns {Promise}
     */

  }, {
    key: 'flush',
    value: function flush() {
      var s = this;
      var filename = s.filename;
      var memory = s.memory;

      return co(_regenerator2.default.mark(function _callee3() {
        return _regenerator2.default.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                if (!s._flushing) {
                  _context3.next = 4;
                  break;
                }

                clearTimeout(s._flushTimer);
                s._flushTimer = setTimeout(function () {
                  return s.flush();
                }, 100);
                return _context3.abrupt('return');

              case 4:
                s._flushing = true;
                _context3.next = 7;
                return writeToFile(filename, memory);

              case 7:
                _context3.next = 9;
                return fileHash(filename);

              case 9:
                s.hash = _context3.sent;

                s._flushing = false;

              case 11:
              case 'end':
                return _context3.stop();
            }
          }
        }, _callee3, this);
      }));
    }

    /**
     * Flush only if needed
     * @returns {Promise}
     */

  }, {
    key: 'flushIfNeeded',
    value: function flushIfNeeded() {
      var s = this;
      return co(_regenerator2.default.mark(function _callee4() {
        return _regenerator2.default.wrap(function _callee4$(_context4) {
          while (1) {
            switch (_context4.prev = _context4.next) {
              case 0:
                if (!s.needsFlush) {
                  _context4.next = 5;
                  break;
                }

                _context4.next = 3;
                return s.flush();

              case 3:
                s.emit('flush', { data: s.memory });
                s.needsFlush = false;

              case 5:
              case 'end':
                return _context4.stop();
            }
          }
        }, _callee4, this);
      }));
    }

    /**
     * Purge data
     * @returns {Promise}
     */

  }, {
    key: 'purge',
    value: function purge() {
      var s = this;
      var filename = s.filename;
      var memory = s.memory;

      clearTimeout(s._flushTimer);
      s.memory = null;
      return co(_regenerator2.default.mark(function _callee5() {
        var exists;
        return _regenerator2.default.wrap(function _callee5$(_context5) {
          while (1) {
            switch (_context5.prev = _context5.next) {
              case 0:
                exists = fs.existsSync(filename);

                if (exists) {
                  fs.unlinkSync(filename);
                  s.emit('purge', { filename: filename, memory: memory });
                }

              case 2:
              case 'end':
                return _context5.stop();
            }
          }
        }, _callee5, this);
      }));
    }
  }, {
    key: 'start',
    value: function start(interval) {
      var s = this;
      if (s._timer) {
        throw new Error('Already started!');
      }
      s._timer = setInterval(function () {
        s.flushIfNeeded();
      }, interval).unref();
      return s;
    }
  }, {
    key: 'stop',
    value: function stop() {
      var s = this;
      clearInterval(s._timer);
      return s;
    }
  }]);
  return Storage;
}(EventEmitter);

module.exports = Storage;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN0b3JhZ2UuanMiXSwibmFtZXMiOlsicmVxdWlyZSIsIkV2ZW50RW1pdHRlciIsImNvIiwiZnMiLCJyZWFkRnJvbUZpbGUiLCJ3cml0ZVRvRmlsZSIsImZpbGVIYXNoIiwiU3RvcmFnZSIsImZpbGVuYW1lIiwicyIsImhhc2giLCJtZW1vcnkiLCJuZWVkc0ZsdXNoIiwiX2ZsdXNoaW5nIiwiX2ZsdXNoVGltZXIiLCJjYWNoZWQiLCJkYXRhIiwiY2xlYXJUaW1lb3V0Iiwic2V0VGltZW91dCIsImZsdXNoIiwiZW1pdCIsImV4aXN0cyIsImV4aXN0c1N5bmMiLCJ1bmxpbmtTeW5jIiwiaW50ZXJ2YWwiLCJfdGltZXIiLCJFcnJvciIsInNldEludGVydmFsIiwiZmx1c2hJZk5lZWRlZCIsInVucmVmIiwiY2xlYXJJbnRlcnZhbCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0FBT0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7ZUFFeUJBLFFBQVEsUUFBUixDOztJQUFqQkMsWSxZQUFBQSxZOztBQUNSLElBQU1DLEtBQUtGLFFBQVEsSUFBUixDQUFYO0FBQ0EsSUFBTUcsS0FBS0gsUUFBUSxJQUFSLENBQVg7QUFDQSxJQUFNSSxlQUFlSixRQUFRLHVCQUFSLENBQXJCO0FBQ0EsSUFBTUssY0FBY0wsUUFBUSxzQkFBUixDQUFwQjtBQUNBLElBQU1NLFdBQVdOLFFBQVEsa0JBQVIsQ0FBakI7O0FBRUE7O0lBQ01PLE87OztBQUNKLG1CQUFhQyxRQUFiLEVBQXVCO0FBQUE7O0FBQUE7O0FBRXJCLFFBQU1DLFNBQU47QUFDQUEsTUFBRUQsUUFBRixHQUFhQSxRQUFiO0FBQ0FDLE1BQUVDLElBQUYsR0FBUyxJQUFUO0FBQ0FELE1BQUVFLE1BQUYsR0FBVyxJQUFYO0FBQ0FGLE1BQUVHLFVBQUYsR0FBZSxLQUFmO0FBQ0FILE1BQUVJLFNBQUYsR0FBYyxLQUFkO0FBQ0FKLE1BQUVLLFdBQUYsR0FBZ0IsQ0FBQyxDQUFqQjtBQVJx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VCw4QkFBRztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFDSm1CLHNCQURJLEdBQ0tsQixHQUFHbUIsVUFBSCxDQUFjZCxRQUFkLENBREw7O0FBRVIsb0JBQUlhLE1BQUosRUFBWTtBQUNWbEIscUJBQUdvQixVQUFILENBQWNmLFFBQWQ7QUFDQUMsb0JBQUVXLElBQUYsQ0FBTyxPQUFQLEVBQWdCLEVBQUVaLGtCQUFGLEVBQVlHLGNBQVosRUFBaEI7QUFDRDs7QUFMTztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxPQUFILEVBQVA7QUFPRDs7OzBCQUVNYSxRLEVBQVU7QUFDZixVQUFNZixJQUFJLElBQVY7QUFDQSxVQUFJQSxFQUFFZ0IsTUFBTixFQUFjO0FBQ1osY0FBTSxJQUFJQyxLQUFKLENBQVUsa0JBQVYsQ0FBTjtBQUNEO0FBQ0RqQixRQUFFZ0IsTUFBRixHQUFXRSxZQUFZLFlBQU07QUFDM0JsQixVQUFFbUIsYUFBRjtBQUNELE9BRlUsRUFFUkosUUFGUSxFQUVFSyxLQUZGLEVBQVg7QUFHQSxhQUFPcEIsQ0FBUDtBQUNEOzs7MkJBRU87QUFDTixVQUFNQSxJQUFJLElBQVY7QUFDQXFCLG9CQUFjckIsRUFBRWdCLE1BQWhCO0FBQ0EsYUFBT2hCLENBQVA7QUFDRDs7O0VBcEhtQlIsWTs7QUF1SHRCOEIsT0FBT0MsT0FBUCxHQUFpQnpCLE9BQWpCIiwiZmlsZSI6InN0b3JhZ2UuanMiLCJzb3VyY2VSb290IjoibGliIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBGaWxlIHN5c3RlbSBzdG9yYWdlXG4gKiBAYXVnbWVudHMgRXZlbnRFbWl0dGVyXG4gKiBAY2xhc3MgU3RvcmFnZVxuICogQHBhcmFtIHtzdHJpbmd9IGZpbGVuYW1lXG4gKiBAcGFyYW0ge09iamVjdH0gZGF0YVxuICovXG4ndXNlIHN0cmljdCdcblxuY29uc3QgeyBFdmVudEVtaXR0ZXIgfSA9IHJlcXVpcmUoJ2V2ZW50cycpXG5jb25zdCBjbyA9IHJlcXVpcmUoJ2NvJylcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKVxuY29uc3QgcmVhZEZyb21GaWxlID0gcmVxdWlyZSgnLi9maWxlL3JlYWRfZnJvbV9maWxlJylcbmNvbnN0IHdyaXRlVG9GaWxlID0gcmVxdWlyZSgnLi9maWxlL3dyaXRlX3RvX2ZpbGUnKVxuY29uc3QgZmlsZUhhc2ggPSByZXF1aXJlKCcuL2ZpbGUvZmlsZV9oYXNoJylcblxuLyoqIEBsZW5kcyBTdG9yYWdlICovXG5jbGFzcyBTdG9yYWdlIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgY29uc3RydWN0b3IgKGZpbGVuYW1lKSB7XG4gICAgc3VwZXIoKVxuICAgIGNvbnN0IHMgPSB0aGlzXG4gICAgcy5maWxlbmFtZSA9IGZpbGVuYW1lXG4gICAgcy5oYXNoID0gbnVsbFxuICAgIHMubWVtb3J5ID0gbnVsbFxuICAgIHMubmVlZHNGbHVzaCA9IGZhbHNlXG4gICAgcy5fZmx1c2hpbmcgPSBmYWxzZVxuICAgIHMuX2ZsdXNoVGltZXIgPSAtMVxuICB9XG5cbiAgLyoqXG4gICAqIFJlYWQgZGF0YVxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICovXG4gIHJlYWQgKCkge1xuICAgIGNvbnN0IHMgPSB0aGlzXG4gICAgbGV0IHsgZmlsZW5hbWUsIG1lbW9yeSB9ID0gc1xuICAgIHJldHVybiBjbyhmdW5jdGlvbiAqICgpIHtcbiAgICAgIGxldCBoYXNoID0geWllbGQgZmlsZUhhc2goZmlsZW5hbWUpXG4gICAgICBsZXQgY2FjaGVkID0gIWhhc2ggfHwgKHMuaGFzaCA9PT0gaGFzaClcbiAgICAgIGlmIChjYWNoZWQpIHtcbiAgICAgICAgcmV0dXJuIG1lbW9yeVxuICAgICAgfVxuICAgICAgcy5oYXNoID0gaGFzaFxuXG4gICAgICBsZXQgZGF0YSA9IHJlYWRGcm9tRmlsZShmaWxlbmFtZSlcbiAgICAgIHMubWVtb3J5ID0gZGF0YVxuICAgICAgcmV0dXJuIGRhdGFcbiAgICB9KVxuICB9XG5cbiAgLyoqXG4gICAqIFdyaXRlIGRhdGFcbiAgICogQHBhcmFtIGRhdGFcbiAgICogQHJldHVybnMgeyp8UHJvbWlzZX1cbiAgICovXG4gIHdyaXRlIChkYXRhKSB7XG4gICAgY29uc3QgcyA9IHRoaXNcbiAgICBsZXQgeyBmaWxlbmFtZSB9ID0gc1xuICAgIHJldHVybiBjbyhmdW5jdGlvbiAqICgpIHtcbiAgICAgIHMubWVtb3J5ID0gZGF0YVxuICAgICAgcy5oYXNoID0geWllbGQgZmlsZUhhc2goZmlsZW5hbWUpXG4gICAgICBzLm5lZWRzRmx1c2ggPSB0cnVlXG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBTYXZlIGRhdGEgaW50byBmaWxlIHN5c3RlbVxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICovXG4gIGZsdXNoICgpIHtcbiAgICBjb25zdCBzID0gdGhpc1xuICAgIGxldCB7IGZpbGVuYW1lLCBtZW1vcnkgfSA9IHNcbiAgICByZXR1cm4gY28oZnVuY3Rpb24gKiAoKSB7XG4gICAgICBpZiAocy5fZmx1c2hpbmcpIHtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHMuX2ZsdXNoVGltZXIpXG4gICAgICAgIHMuX2ZsdXNoVGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHMuZmx1c2goKSwgMTAwKVxuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIHMuX2ZsdXNoaW5nID0gdHJ1ZVxuICAgICAgeWllbGQgd3JpdGVUb0ZpbGUoZmlsZW5hbWUsIG1lbW9yeSlcbiAgICAgIHMuaGFzaCA9IHlpZWxkIGZpbGVIYXNoKGZpbGVuYW1lKVxuICAgICAgcy5fZmx1c2hpbmcgPSBmYWxzZVxuICAgIH0pXG4gIH1cblxuICAvKipcbiAgICogRmx1c2ggb25seSBpZiBuZWVkZWRcbiAgICogQHJldHVybnMge1Byb21pc2V9XG4gICAqL1xuICBmbHVzaElmTmVlZGVkICgpIHtcbiAgICBjb25zdCBzID0gdGhpc1xuICAgIHJldHVybiBjbyhmdW5jdGlvbiAqICgpIHtcbiAgICAgIGlmIChzLm5lZWRzRmx1c2gpIHtcbiAgICAgICAgeWllbGQgcy5mbHVzaCgpXG4gICAgICAgIHMuZW1pdCgnZmx1c2gnLCB7IGRhdGE6IHMubWVtb3J5IH0pXG4gICAgICAgIHMubmVlZHNGbHVzaCA9IGZhbHNlXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBQdXJnZSBkYXRhXG4gICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgKi9cbiAgcHVyZ2UgKCkge1xuICAgIGNvbnN0IHMgPSB0aGlzXG4gICAgbGV0IHsgZmlsZW5hbWUsIG1lbW9yeSB9ID0gc1xuICAgIGNsZWFyVGltZW91dChzLl9mbHVzaFRpbWVyKVxuICAgIHMubWVtb3J5ID0gbnVsbFxuICAgIHJldHVybiBjbyhmdW5jdGlvbiAqICgpIHtcbiAgICAgIGxldCBleGlzdHMgPSBmcy5leGlzdHNTeW5jKGZpbGVuYW1lKVxuICAgICAgaWYgKGV4aXN0cykge1xuICAgICAgICBmcy51bmxpbmtTeW5jKGZpbGVuYW1lKVxuICAgICAgICBzLmVtaXQoJ3B1cmdlJywgeyBmaWxlbmFtZSwgbWVtb3J5IH0pXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHN0YXJ0IChpbnRlcnZhbCkge1xuICAgIGNvbnN0IHMgPSB0aGlzXG4gICAgaWYgKHMuX3RpbWVyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FscmVhZHkgc3RhcnRlZCEnKVxuICAgIH1cbiAgICBzLl90aW1lciA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgIHMuZmx1c2hJZk5lZWRlZCgpXG4gICAgfSwgaW50ZXJ2YWwpLnVucmVmKClcbiAgICByZXR1cm4gc1xuICB9XG5cbiAgc3RvcCAoKSB7XG4gICAgY29uc3QgcyA9IHRoaXNcbiAgICBjbGVhckludGVydmFsKHMuX3RpbWVyKVxuICAgIHJldHVybiBzXG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTdG9yYWdlXG4iXX0=