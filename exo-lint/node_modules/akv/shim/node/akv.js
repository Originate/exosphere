/**
 * A simple key value store
 * @class AKV
 * @param {string} filename - Filename to store data
 * @param {Object} [options]
 * @param {number} [options.interval=1000] - Flush interval
 */
'use strict';

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Storage = require('./storage');
var co = require('co');

/** @lends AKV */

var AKV = function () {
  function AKV(filename) {
    var options = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
    (0, _classCallCheck3.default)(this, AKV);

    var s = this;
    if (!filename) {
      throw new Error('filename is required');
    }
    var _options$interval = options.interval;
    var interval = _options$interval === undefined ? 1000 : _options$interval;

    s.storage = new Storage(filename, { interval: interval }).start(interval);

    process.setMaxListeners(process.getMaxListeners() + 2);
    process.on('beforeExit', function () {
      return s.handleBeforeExit();
    });
    process.on('exit', function () {
      return s.handleExit();
    });
  }

  /**
   * Touch file
   * @function touch
   * @returns {Promise}
   */


  (0, _createClass3.default)(AKV, [{
    key: 'touch',
    value: function touch() {
      var s = this;
      var storage = s.storage;

      return co(_regenerator2.default.mark(function _callee() {
        var data;
        return _regenerator2.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                _context.next = 2;
                return storage.read();

              case 2:
                data = _context.sent;

                data = data || {};
                _context.next = 6;
                return storage.write(data);

              case 6:
                _context.next = 8;
                return storage.flush();

              case 8:
              case 'end':
                return _context.stop();
            }
          }
        }, _callee, this);
      }));
    }

    /**
     * Set a value
     * @function set
     * @param {string} key
     * @param {string} value
     * @returns {Promise}
     */

  }, {
    key: 'set',
    value: function set(key, value) {
      var s = this;
      var storage = s.storage;

      return co(_regenerator2.default.mark(function _callee2() {
        var data;
        return _regenerator2.default.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                _context2.next = 2;
                return storage.read();

              case 2:
                data = _context2.sent;

                data = data || {};
                data[key] = value;
                _context2.next = 7;
                return storage.write(data);

              case 7:
              case 'end':
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));
    }

    /**
     * Get all keys
     * @function keys
     * @returns {Promise}
     */

  }, {
    key: 'keys',
    value: function keys() {
      var s = this;
      var storage = s.storage;

      return co(_regenerator2.default.mark(function _callee3() {
        var data;
        return _regenerator2.default.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                _context3.next = 2;
                return storage.read();

              case 2:
                data = _context3.sent;
                return _context3.abrupt('return', (0, _keys2.default)(data || {}));

              case 4:
              case 'end':
                return _context3.stop();
            }
          }
        }, _callee3, this);
      }));
    }

    /**
     * Get a value
     * @function get
     * @param {string} key
     * @returns {Promise}
     */

  }, {
    key: 'get',
    value: function get(key) {
      var s = this;
      var storage = s.storage;

      return co(_regenerator2.default.mark(function _callee4() {
        var data;
        return _regenerator2.default.wrap(function _callee4$(_context4) {
          while (1) {
            switch (_context4.prev = _context4.next) {
              case 0:
                _context4.next = 2;
                return storage.read();

              case 2:
                data = _context4.sent;
                return _context4.abrupt('return', data && data[key]);

              case 4:
              case 'end':
                return _context4.stop();
            }
          }
        }, _callee4, this);
      }));
    }

    /**
     * Get all values
     * @function all
     * @returns {Promise}
     */

  }, {
    key: 'all',
    value: function all() {
      var s = this;
      var storage = s.storage;

      return co(_regenerator2.default.mark(function _callee5() {
        var data;
        return _regenerator2.default.wrap(function _callee5$(_context5) {
          while (1) {
            switch (_context5.prev = _context5.next) {
              case 0:
                _context5.next = 2;
                return storage.read();

              case 2:
                data = _context5.sent;
                return _context5.abrupt('return', data || {});

              case 4:
              case 'end':
                return _context5.stop();
            }
          }
        }, _callee5, this);
      }));
    }

    /**
     * Delete a value
     * @function del
     * @param {string} key
     * @returns {Promise}
     */

  }, {
    key: 'del',
    value: function del(key) {
      var s = this;
      var storage = s.storage;

      return co(_regenerator2.default.mark(function _callee6() {
        var data;
        return _regenerator2.default.wrap(function _callee6$(_context6) {
          while (1) {
            switch (_context6.prev = _context6.next) {
              case 0:
                _context6.next = 2;
                return storage.read();

              case 2:
                data = _context6.sent;

                if (data) {
                  _context6.next = 5;
                  break;
                }

                return _context6.abrupt('return');

              case 5:
                delete data[key];
                _context6.next = 8;
                return storage.write(data);

              case 8:
              case 'end':
                return _context6.stop();
            }
          }
        }, _callee6, this);
      }));
    }

    /**
     * Delete all values
     * @function destroy
     * @returns {Promise}
     */

  }, {
    key: 'destroy',
    value: function destroy() {
      var s = this;
      var storage = s.storage;

      return co(_regenerator2.default.mark(function _callee7() {
        return _regenerator2.default.wrap(function _callee7$(_context7) {
          while (1) {
            switch (_context7.prev = _context7.next) {
              case 0:
                _context7.next = 2;
                return storage.purge();

              case 2:
              case 'end':
                return _context7.stop();
            }
          }
        }, _callee7, this);
      }));
    }

    /**
     * Commit changes
     * @returns {Promise}
     */

  }, {
    key: 'commit',
    value: function commit() {
      var s = this;
      var storage = s.storage;

      return co(_regenerator2.default.mark(function _callee8() {
        return _regenerator2.default.wrap(function _callee8$(_context8) {
          while (1) {
            switch (_context8.prev = _context8.next) {
              case 0:
                _context8.next = 2;
                return storage.flush();

              case 2:
                storage.needsFlush = false;

              case 3:
              case 'end':
                return _context8.stop();
            }
          }
        }, _callee8, this);
      }));
    }
  }, {
    key: 'handleBeforeExit',
    value: function handleBeforeExit() {
      var s = this;
      var storage = s.storage;

      storage.flushIfNeeded();
      storage.needsFlush = false;
    }
  }, {
    key: 'handleExit',
    value: function handleExit() {
      var s = this;
      var storage = s.storage;

      if (s.storage.needsFlush) {
        console.warn('[akv] Some uncommitted change has lost. Make sure to call akv.commit() before existing.');
      }
    }
  }]);
  return AKV;
}();

module.exports = AKV;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFrdi5qcyJdLCJuYW1lcyI6WyJTdG9yYWdlIiwicmVxdWlyZSIsImNvIiwiQUtWIiwiZmlsZW5hbWUiLCJvcHRpb25zIiwicyIsIkVycm9yIiwiaW50ZXJ2YWwiLCJzdG9yYWdlIiwic3RhcnQiLCJwcm9jZXNzIiwic2V0TWF4TGlzdGVuZXJzIiwiZ2V0TWF4TGlzdGVuZXJzIiwib24iLCJoYW5kbGVCZWZvcmVFeGl0IiwiaGFuZGxlRXhpdCIsInJlYWQiLCJkYXRhIiwid3JpdGUiLCJmbHVzaCIsImtleSIsInZhbHVlIiwicHVyZ2UiLCJuZWVkc0ZsdXNoIiwiZmx1c2hJZk5lZWRlZCIsImNvbnNvbGUiLCJ3YXJuIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7QUFPQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFQSxJQUFNQSxVQUFVQyxRQUFRLFdBQVIsQ0FBaEI7QUFDQSxJQUFNQyxLQUFLRCxRQUFRLElBQVIsQ0FBWDs7QUFFQTs7SUFDTUUsRztBQUNKLGVBQWFDLFFBQWIsRUFBcUM7QUFBQSxRQUFkQyxPQUFjLHlEQUFKLEVBQUk7QUFBQTs7QUFDbkMsUUFBTUMsSUFBSSxJQUFWO0FBQ0EsUUFBSSxDQUFDRixRQUFMLEVBQWU7QUFDYixZQUFNLElBQUlHLEtBQUosQ0FBVSxzQkFBVixDQUFOO0FBQ0Q7QUFKa0MsNEJBTy9CRixPQVArQixDQU1qQ0csUUFOaUM7QUFBQSxRQU1qQ0EsUUFOaUMscUNBTXRCLElBTnNCOztBQVFuQ0YsTUFBRUcsT0FBRixHQUFZLElBQUlULE9BQUosQ0FBWUksUUFBWixFQUFzQixFQUFFSSxrQkFBRixFQUF0QixFQUFvQ0UsS0FBcEMsQ0FBMENGLFFBQTFDLENBQVo7O0FBRUFHLFlBQVFDLGVBQVIsQ0FBd0JELFFBQVFFLGVBQVIsS0FBNEIsQ0FBcEQ7QUFDQUYsWUFBUUcsRUFBUixDQUFXLFlBQVgsRUFBeUI7QUFBQSxhQUFNUixFQUFFUyxnQkFBRixFQUFOO0FBQUEsS0FBekI7QUFDQUos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LENBTkU7O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsT0FBSCxFQUFQO0FBUUQ7O0FBRUQ7Ozs7Ozs7OzhCQUtXO0FBQ1QsVUFBTVosSUFBSSxJQUFWO0FBRFMsVUFFSEcsT0FGRyxHQUVTSCxDQUZULENBRUhHLE9BRkc7O0FBR1QsYUFBT1AsOEJBQUc7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsdUJBQ0ZPLFFBQVFjLEtBQVIsRUFERTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxPQUFILEVBQVA7QUFHRDs7QUFFRDs7Ozs7Ozs2QkFJVTtBQUNSLFVBQU1qQixJQUFJLElBQVY7QUFEUSxVQUVGRyxPQUZFLEdBRVVILENBRlYsQ0FFRkcsT0FGRTs7QUFHUixhQUFPUCw4QkFBRztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSx1QkFDRk8sUUFBUVcsS0FBUixFQURFOztBQUFBO0FBRVJYLHdCQUFRZSxVQUFSLEdBQXFCLEtBQXJCOztBQUZRO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLE9BQUgsRUFBUDtBQUlEOzs7dUNBRW1CO0FBQ2xCLFVBQU1sQixJQUFJLElBQVY7QUFEa0IsVUFFWkcsT0FGWSxHQUVBSCxDQUZBLENBRVpHLE9BRlk7O0FBR2xCQSxjQUFRZ0IsYUFBUjtBQUNBaEIsY0FBUWUsVUFBUixHQUFxQixLQUFyQjtBQUNEOzs7aUNBRWE7QUFDWixVQUFNbEIsSUFBSSxJQUFWO0FBRFksVUFFTkcsT0FGTSxHQUVNSCxDQUZOLENBRU5HLE9BRk07O0FBR1osVUFBSUgsRUFBRUcsT0FBRixDQUFVZSxVQUFkLEVBQTBCO0FBQ3hCRSxnQkFBUUMsSUFBUixDQUFhLHlGQUFiO0FBQ0Q7QUFDRjs7Ozs7QUFHSEMsT0FBT0MsT0FBUCxHQUFpQjFCLEdBQWpCIiwiZmlsZSI6ImFrdi5qcyIsInNvdXJjZVJvb3QiOiJsaWIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEEgc2ltcGxlIGtleSB2YWx1ZSBzdG9yZVxuICogQGNsYXNzIEFLVlxuICogQHBhcmFtIHtzdHJpbmd9IGZpbGVuYW1lIC0gRmlsZW5hbWUgdG8gc3RvcmUgZGF0YVxuICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXVxuICogQHBhcmFtIHtudW1iZXJ9IFtvcHRpb25zLmludGVydmFsPTEwMDBdIC0gRmx1c2ggaW50ZXJ2YWxcbiAqL1xuJ3VzZSBzdHJpY3QnXG5cbmNvbnN0IFN0b3JhZ2UgPSByZXF1aXJlKCcuL3N0b3JhZ2UnKVxuY29uc3QgY28gPSByZXF1aXJlKCdjbycpXG5cbi8qKiBAbGVuZHMgQUtWICovXG5jbGFzcyBBS1Yge1xuICBjb25zdHJ1Y3RvciAoZmlsZW5hbWUsIG9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHMgPSB0aGlzXG4gICAgaWYgKCFmaWxlbmFtZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdmaWxlbmFtZSBpcyByZXF1aXJlZCcpXG4gICAgfVxuICAgIGxldCB7XG4gICAgICBpbnRlcnZhbCA9IDEwMDBcbiAgICB9ID0gb3B0aW9uc1xuICAgIHMuc3RvcmFnZSA9IG5ldyBTdG9yYWdlKGZpbGVuYW1lLCB7IGludGVydmFsIH0pLnN0YXJ0KGludGVydmFsKVxuXG4gICAgcHJvY2Vzcy5zZXRNYXhMaXN0ZW5lcnMocHJvY2Vzcy5nZXRNYXhMaXN0ZW5lcnMoKSArIDIpXG4gICAgcHJvY2Vzcy5vbignYmVmb3JlRXhpdCcsICgpID0+IHMuaGFuZGxlQmVmb3JlRXhpdCgpKVxuICAgIHByb2Nlc3Mub24oJ2V4aXQnLCAoKSA9PiBzLmhhbmRsZUV4aXQoKSlcbiAgfVxuXG4gIC8qKlxuICAgKiBUb3VjaCBmaWxlXG4gICAqIEBmdW5jdGlvbiB0b3VjaFxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICovXG4gIHRvdWNoICgpIHtcbiAgICBjb25zdCBzID0gdGhpc1xuICAgIGxldCB7IHN0b3JhZ2UgfSA9IHNcbiAgICByZXR1cm4gY28oZnVuY3Rpb24gKiAoKSB7XG4gICAgICBsZXQgZGF0YSA9IHlpZWxkIHN0b3JhZ2UucmVhZCgpXG4gICAgICBkYXRhID0gZGF0YSB8fCB7fVxuICAgICAgeWllbGQgc3RvcmFnZS53cml0ZShkYXRhKVxuICAgICAgeWllbGQgc3RvcmFnZS5mbHVzaCgpXG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgYSB2YWx1ZVxuICAgKiBAZnVuY3Rpb24gc2V0XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBrZXlcbiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlXG4gICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgKi9cbiAgc2V0IChrZXksIHZhbHVlKSB7XG4gICAgY29uc3QgcyA9IHRoaXNcbiAgICBsZXQgeyBzdG9yYWdlIH0gPSBzXG4gICAgcmV0dXJuIGNvKGZ1bmN0aW9uICogKCkge1xuICAgICAgbGV0IGRhdGEgPSB5aWVsZCBzdG9yYWdlLnJlYWQoKVxuICAgICAgZGF0YSA9IGRhdGEgfHwge31cbiAgICAgIGRhdGFbIGtleSBdID0gdmFsdWVcbiAgICAgIHlpZWxkIHN0b3JhZ2Uud3JpdGUoZGF0YSlcbiAgICB9KVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhbGwga2V5c1xuICAgKiBAZnVuY3Rpb24ga2V5c1xuICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICovXG4gIGtleXMgKCkge1xuICAgIGNvbnN0IHMgPSB0aGlzXG4gICAgbGV0IHsgc3RvcmFnZSB9ID0gc1xuICAgIHJldHVybiBjbyhmdW5jdGlvbiAqICgpIHtcbiAgICAgIGxldCBkYXRhID0geWllbGQgc3RvcmFnZS5yZWFkKClcbiAgICAgIHJldHVybiBPYmplY3Qua2V5cyhkYXRhIHx8IHt9KVxuICAgIH0pXG4gIH1cblxuICAvKipcbiAgICogR2V0IGEgdmFsdWVcbiAgICogQGZ1bmN0aW9uIGdldFxuICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5XG4gICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgKi9cbiAgZ2V0IChrZXkpIHtcbiAgICBjb25zdCBzID0gdGhpc1xuICAgIGxldCB7IHN0b3JhZ2UgfSA9IHNcbiAgICByZXR1cm4gY28oZnVuY3Rpb24gKiAoKSB7XG4gICAgICBsZXQgZGF0YSA9IHlpZWxkIHN0b3JhZ2UucmVhZCgpXG4gICAgICByZXR1cm4gZGF0YSAmJiBkYXRhWyBrZXkgXVxuICAgIH0pXG4gIH1cblxuICAvKipcbiAgICogR2V0IGFsbCB2YWx1ZXNcbiAgICogQGZ1bmN0aW9uIGFsbFxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICovXG4gIGFsbCAoKSB7XG4gICAgY29uc3QgcyA9IHRoaXNcbiAgICBsZXQgeyBzdG9yYWdlIH0gPSBzXG4gICAgcmV0dXJuIGNvKGZ1bmN0aW9uICogKCkge1xuICAgICAgbGV0IGRhdGEgPSB5aWVsZCBzdG9yYWdlLnJlYWQoKVxuICAgICAgcmV0dXJuIGRhdGEgfHwge31cbiAgICB9KVxuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSBhIHZhbHVlXG4gICAqIEBmdW5jdGlvbiBkZWxcbiAgICogQHBhcmFtIHtzdHJpbmd9IGtleVxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICovXG4gIGRlbCAoa2V5KSB7XG4gICAgY29uc3QgcyA9IHRoaXNcbiAgICBsZXQgeyBzdG9yYWdlIH0gPSBzXG4gICAgcmV0dXJuIGNvKGZ1bmN0aW9uICogKCkge1xuICAgICAgbGV0IGRhdGEgPSB5aWVsZCBzdG9yYWdlLnJlYWQoKVxuICAgICAgaWYgKCFkYXRhKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgZGVsZXRlIGRhdGFbIGtleSBdXG4gICAgICB5aWVsZCBzdG9yYWdlLndyaXRlKGRhdGEpXG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxldGUgYWxsIHZhbHVlc1xuICAgKiBAZnVuY3Rpb24gZGVzdHJveVxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICovXG4gIGRlc3Ryb3kgKCkge1xuICAgIGNvbnN0IHMgPSB0aGlzXG4gICAgbGV0IHsgc3RvcmFnZSB9ID0gc1xuICAgIHJldHVybiBjbyhmdW5jdGlvbiAqICgpIHtcbiAgICAgIHlpZWxkIHN0b3JhZ2UucHVyZ2UoKVxuICAgIH0pXG4gIH1cblxuICAvKipcbiAgICogQ29tbWl0IGNoYW5nZXNcbiAgICogQHJldHVybnMge1Byb21pc2V9XG4gICAqL1xuICBjb21taXQgKCkge1xuICAgIGNvbnN0IHMgPSB0aGlzXG4gICAgbGV0IHsgc3RvcmFnZSB9ID0gc1xuICAgIHJldHVybiBjbyhmdW5jdGlvbiAqICgpIHtcbiAgICAgIHlpZWxkIHN0b3JhZ2UuZmx1c2goKVxuICAgICAgc3RvcmFnZS5uZWVkc0ZsdXNoID0gZmFsc2VcbiAgICB9KVxuICB9XG5cbiAgaGFuZGxlQmVmb3JlRXhpdCAoKSB7XG4gICAgY29uc3QgcyA9IHRoaXNcbiAgICBsZXQgeyBzdG9yYWdlIH0gPSBzXG4gICAgc3RvcmFnZS5mbHVzaElmTmVlZGVkKClcbiAgICBzdG9yYWdlLm5lZWRzRmx1c2ggPSBmYWxzZVxuICB9XG5cbiAgaGFuZGxlRXhpdCAoKSB7XG4gICAgY29uc3QgcyA9IHRoaXNcbiAgICBsZXQgeyBzdG9yYWdlIH0gPSBzXG4gICAgaWYgKHMuc3RvcmFnZS5uZWVkc0ZsdXNoKSB7XG4gICAgICBjb25zb2xlLndhcm4oJ1tha3ZdIFNvbWUgdW5jb21taXR0ZWQgY2hhbmdlIGhhcyBsb3N0LiBNYWtlIHN1cmUgdG8gY2FsbCBha3YuY29tbWl0KCkgYmVmb3JlIGV4aXN0aW5nLicpXG4gICAgfVxuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQUtWXG4iXX0=