/**
 * Compile files
 * @function ababel
 * @param {string} pattern - Glob file name pattern
 * @param {Object} [options] - Optional settings
 * @param {string} [options.status] - Status file path
 * @param {string} [options.cwd] - Current working directory path
 * @param {string} [options.out] - Output directory path
 * @param {boolean} [options.minified] - Minified or not
 * @param {string[]} [options.reflects] - File patterns to reflects changes
 * @returns {Promise}
 */
'use strict';

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _toConsumableArray2 = require('babel-runtime/helpers/toConsumableArray');

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var aglob = require('aglob');
var convertSourceMap = require('convert-source-map');
var writeout = require('writeout');
var akvStatus = require('akv-status');
var co = require('co');
var path = require('path');
var filedel = require('filedel');

var _require = require('asfs');

var statAsync = _require.statAsync;

var _require2 = require('asenv');

var isProduction = _require2.isProduction;

var _require3 = require('babel-core');

var transformFile = _require3.transformFile;

var _require4 = require('./constants');

var DEFAULT_PRESET = _require4.DEFAULT_PRESET;
var DEFAULT_EXT = _require4.DEFAULT_EXT;

var _require5 = require('./helpers/file_helper');

var replaceExt = _require5.replaceExt;

var relative = function relative(filename) {
  return path.relative(process.cwd(), filename);
};
var mtime = function mtime(filename) {
  return statAsync(filename).catch(function () {
    return null;
  }).then(function (_ref) {
    var mtime = _ref.mtime;
    return mtime;
  });
};

/** @lends ababel */
function ababel(pattern) {
  var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
  var _options$status = options.status;
  var status = _options$status === undefined ? 'tmp/ababel.status.json' : _options$status;
  var _options$cwd = options.cwd;
  var cwd = _options$cwd === undefined ? process.cwd() : _options$cwd;
  var _options$out = options.out;
  var out = _options$out === undefined ? process.cwd() : _options$out;
  var _options$presets = options.presets;
  var presets = _options$presets === undefined ? DEFAULT_PRESET.split(',') : _options$presets;
  var _options$sourceMaps = options.sourceMaps;
  var sourceMaps = _options$sourceMaps === undefined ? !isProduction() : _options$sourceMaps;
  var _options$minified = options.minified;
  var minified = _options$minified === undefined ? false : _options$minified;
  var _options$ignore = options.ignore;
  var ignore = _options$ignore === undefined ? [] : _options$ignore;
  var _options$reflects = options.reflects;
  var reflects = _options$reflects === undefined ? [] : _options$reflects;
  var _options$ext = options.ext;
  var ext = _options$ext === undefined ? DEFAULT_EXT.split(',') : _options$ext;


  var store = akvStatus(status);
  return co(_regenerator2.default.mark(function _callee() {
    var _this = this;

    var filenames, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _loop, _iterator, _step, _ret;

    return _regenerator2.default.wrap(function _callee$(_context2) {
      while (1) {
        switch (_context2.prev = _context2.next) {
          case 0:
            _context2.next = 2;
            return aglob(pattern, { cwd: cwd, ignore: ignore });

          case 2:
            filenames = _context2.sent;
            _context2.next = 5;
            return aglob(reflects);

          case 5:
            reflects = _context2.sent;
            _iteratorNormalCompletion = true;
            _didIteratorError = false;
            _iteratorError = undefined;
            _context2.prev = 9;
            _loop = _regenerator2.default.mark(function _loop() {
              var filename, src, dest, changed, srcMtime, destMtime, skip, _ref2, code, map, ast, _ref3, skipped;

              return _regenerator2.default.wrap(function _loop$(_context) {
                while (1) {
                  switch (_context.prev = _context.next) {
                    case 0:
                      filename = _step.value;
                      src = path.resolve(cwd, filename);
                      dest = path.resolve(out, ext.reduce(function (filename, ext) {
                        return replaceExt(filename, ext, '.js');
                      }, filename));

                      if (isProduction()) {
                        _context.next = 17;
                        break;
                      }

                      _context.next = 6;
                      return store.filterStatusUnknown([src, dest].concat((0, _toConsumableArray3.default)(reflects)));

                    case 6:
                      changed = _context.sent;

                      if (!(changed.length === 0)) {
                        _context.next = 17;
                        break;
                      }

                      _context.next = 10;
                      return mtime(src);

                    case 10:
                      srcMtime = _context.sent;
                      _context.next = 13;
                      return mtime(dest);

                    case 13:
                      destMtime = _context.sent;
                      skip = srcMtime && destMtime && srcMtime <= destMtime;

                      if (!skip) {
                        _context.next = 17;
                        break;
                      }

                      return _context.abrupt('return', 'continue');

                    case 17:
                      _context.next = 19;
                      return new _promise2.default(function (resolve, reject) {
                        var options = {
                          presets: presets,
                          minified: minified,
                          sourceMaps: sourceMaps,
                          compact: false,
                          babelrc: false,
                          sourceRoot: path.relative(process.cwd(), cwd),
                          plugins: ['transform-runtime']
                        };
                        transformFile(src, options, function (err, result) {
                          return err ? reject(err) : resolve(result);
                        });
                      });

                    case 19:
                      _ref2 = _context.sent;
                      code = _ref2.code;
                      map = _ref2.map;
                      ast = _ref2.ast;
                      _context.prev = 23;

                      if (!(dest !== src)) {
                        _context.next = 27;
                        break;
                      }

                      _context.next = 27;
                      return filedel(dest);

                    case 27:
                      _context.next = 31;
                      break;

                    case 29:
                      _context.prev = 29;
                      _context.t0 = _context['catch'](23);

                    case 31:
                      _context.next = 33;
                      return writeout(dest, code + '\n' + convertSourceMap.fromObject(map).toComment(), {
                        mkdirp: true,
                        skipIfIdentical: true
                      });

                    case 33:
                      _ref3 = _context.sent;
                      skipped = _ref3.skipped;

                      if (!skipped) {
                        console.log('File generated: ' + relative(dest));
                      }

                      _context.next = 38;
                      return store.saveStatus([src, dest].concat((0, _toConsumableArray3.default)(reflects)));

                    case 38:
                    case 'end':
                      return _context.stop();
                  }
                }
              }, _loop, _this, [[23, 29]]);
            });
            _iterator = (0, _getIterator3.default)(filenames);

          case 12:
            if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
              _context2.next = 20;
              break;
            }

            return _context2.delegateYield(_loop(), 't0', 14);

          case 14:
            _ret = _context2.t0;

            if (!(_ret === 'continue')) {
              _context2.next = 17;
              break;
            }

            return _context2.abrupt('continue', 17);

          case 17:
            _iteratorNormalCompletion = true;
            _context2.next = 12;
            break;

          case 20:
            _context2.next = 26;
            break;

          case 22:
            _context2.prev = 22;
            _context2.t1 = _context2['catch'](9);
            _didIteratorError = true;
            _iteratorError = _context2.t1;

          case 26:
            _context2.prev = 26;
            _context2.prev = 27;

            if (!_iteratorNormalCompletion && _iterator.return) {
              _iterator.return();
            }

          case 29:
            _context2.prev = 29;

            if (!_didIteratorError) {
              _context2.next = 32;
              break;
            }

            throw _iteratorError;

          case 32:
            return _context2.finish(29);

          case 33:
            return _context2.finish(26);

          case 34:
          case 'end':
            return _context2.stop();
        }
      }
    }, _callee, this, [[9, 22, 26, 34], [27,, 29, 33]]);
  })).catch(function (err) {
    return co(_regenerator2.default.mark(function _callee2() {
      return _regenerator2.default.wrap(function _callee2$(_context3) {
        while (1) {
          switch (_context3.prev = _context3.next) {
            case 0:
              _context3.next = 2;
              return store.destroy();

            case 2:
              throw err;

            case 3:
            case 'end':
              return _context3.stop();
          }
        }
      }, _callee2, this);
    }));
  });
}

module.exports = ababel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFiYWJlbC5qcyJdLCJuYW1lcyI6WyJhZ2xvYiIsInJlcXVpcmUiLCJjb252ZXJ0U291cmNlTWFwIiwid3JpdGVvdXQiLCJha3ZTdGF0dXMiLCJjbyIsInBhdGgiLCJmaWxlZGVsIiwic3RhdEFzeW5jIiwiaXNQcm9kdWN0aW9uIiwidHJhbnNmb3JtRmlsZSIsIkRFRkFVTFRfUFJFU0VUIiwiREVGQVVMVF9FWFQiLCJyZXBsYWNlRXh0IiwicmVsYXRpdmUiLCJmaWxlbmFtZSIsInByb2Nlc3MiLCJjd2QiLCJtdGltZSIsImNhdGNoIiwidGhlbiIsImFiYWJlbCIsInBhdHRlcm4iLCJvcHRpb25zIiwic3RhdHVzIiwib3V0IiwicHJlc2V0cyIsInNwbGl0Iiwic291cmNlTWFwcyIsIm1pbmlmaWVkIiwiaWdub3JlIiwicmVmbGVjdHMiLCJleHQiLCJzdG9yZSIsImZpbGVuYW1lcyIsInNyYyIsInJlc29sdmUiLCJkZXN0IiwicmVkdWNlIiwiZmlsdGVyU3RhdHVzVW5rbm93biIsImNoYW5nZWQiLCJsZW5ndGgiLCJzcmNNdGltZSIsImRlc3RNdGltZSIsInNraXAiLCJyZWplY3QiLCJjb21wYWN0IiwiYmFiZWxyYyIsInNvdXJjZVJvb3QiLCJwbHVnaW5zIiwiZXJyIiwicmVzdWx0IiwiY29kZSIsIm1hcCIsImFzdCIsImZyb21PYmplY3QiLCJ0b0NvbW1lbnQiLCJta2RpcnAiLCJza2lwSWZJZGVudGljYWwiLCJza2lwcGVkIiwiY29uc29sZSIsImxvZyIsInNhdmVTdGF0dXMiLCJkZXN0cm95IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7OztBQVlBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBLElBQU1BLFFBQVFDLFFBQVEsT0FBUixDQUFkO0FBQ0EsSUFBTUMsbUJBQW1CRCxRQUFRLG9CQUFSLENBQXpCO0FBQ0EsSUFBTUUsV0FBV0YsUUFBUSxVQUFSLENBQWpCO0FBQ0EsSUFBTUcsWUFBWUgsUUFBUSxZQUFSLENB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O0FBQUE7QUFBQSxxQkFDYjRCLE1BQU04QixPQUFOLEVBRGE7O0FBQUE7QUFBQSxvQkFFYmIsR0FGYTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxLQUFILEVBQVQ7QUFBQSxHQTlDRixDQUFQO0FBa0REOztBQUVEYyxPQUFPQyxPQUFQLEdBQWlCNUMsTUFBakIiLCJmaWxlIjoiYWJhYmVsLmpzIiwic291cmNlUm9vdCI6ImxpYiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29tcGlsZSBmaWxlc1xuICogQGZ1bmN0aW9uIGFiYWJlbFxuICogQHBhcmFtIHtzdHJpbmd9IHBhdHRlcm4gLSBHbG9iIGZpbGUgbmFtZSBwYXR0ZXJuXG4gKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIC0gT3B0aW9uYWwgc2V0dGluZ3NcbiAqIEBwYXJhbSB7c3RyaW5nfSBbb3B0aW9ucy5zdGF0dXNdIC0gU3RhdHVzIGZpbGUgcGF0aFxuICogQHBhcmFtIHtzdHJpbmd9IFtvcHRpb25zLmN3ZF0gLSBDdXJyZW50IHdvcmtpbmcgZGlyZWN0b3J5IHBhdGhcbiAqIEBwYXJhbSB7c3RyaW5nfSBbb3B0aW9ucy5vdXRdIC0gT3V0cHV0IGRpcmVjdG9yeSBwYXRoXG4gKiBAcGFyYW0ge2Jvb2xlYW59IFtvcHRpb25zLm1pbmlmaWVkXSAtIE1pbmlmaWVkIG9yIG5vdFxuICogQHBhcmFtIHtzdHJpbmdbXX0gW29wdGlvbnMucmVmbGVjdHNdIC0gRmlsZSBwYXR0ZXJucyB0byByZWZsZWN0cyBjaGFuZ2VzXG4gKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAqL1xuJ3VzZSBzdHJpY3QnXG5cbmNvbnN0IGFnbG9iID0gcmVxdWlyZSgnYWdsb2InKVxuY29uc3QgY29udmVydFNvdXJjZU1hcCA9IHJlcXVpcmUoJ2NvbnZlcnQtc291cmNlLW1hcCcpXG5jb25zdCB3cml0ZW91dCA9IHJlcXVpcmUoJ3dyaXRlb3V0JylcbmNvbnN0IGFrdlN0YXR1cyA9IHJlcXVpcmUoJ2Frdi1zdGF0dXMnKVxuY29uc3QgY28gPSByZXF1aXJlKCdjbycpXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5jb25zdCBmaWxlZGVsID0gcmVxdWlyZSgnZmlsZWRlbCcpXG5jb25zdCB7IHN0YXRBc3luYyB9ID0gcmVxdWlyZSgnYXNmcycpXG5jb25zdCB7IGlzUHJvZHVjdGlvbiB9ID0gcmVxdWlyZSgnYXNlbnYnKVxuY29uc3QgeyB0cmFuc2Zvcm1GaWxlIH0gPSByZXF1aXJlKCdiYWJlbC1jb3JlJylcbmNvbnN0IHsgREVGQVVMVF9QUkVTRVQsIERFRkFVTFRfRVhUIH0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpXG5cbmxldCB7IHJlcGxhY2VFeHQgfSA9IHJlcXVpcmUoJy4vaGVscGVycy9maWxlX2hlbHBlcicpXG5sZXQgcmVsYXRpdmUgPSAoZmlsZW5hbWUpID0+IHBhdGgucmVsYXRpdmUocHJvY2Vzcy5jd2QoKSwgZmlsZW5hbWUpXG5sZXQgbXRpbWUgPSAoZmlsZW5hbWUpID0+IHN0YXRBc3luYyhmaWxlbmFtZSkuY2F0Y2goKCkgPT4gbnVsbCkudGhlbigoe210aW1lfSkgPT4gbXRpbWUpXG5cbi8qKiBAbGVuZHMgYWJhYmVsICovXG5mdW5jdGlvbiBhYmFiZWwgKHBhdHRlcm4sIG9wdGlvbnMgPSB7fSkge1xuICBsZXQge1xuICAgIHN0YXR1cyA9ICd0bXAvYWJhYmVsLnN0YXR1cy5qc29uJyxcbiAgICBjd2QgPSBwcm9jZXNzLmN3ZCgpLFxuICAgIG91dCA9IHByb2Nlc3MuY3dkKCksXG4gICAgcHJlc2V0cyA9IERFRkFVTFRfUFJFU0VULnNwbGl0KCcsJyksXG4gICAgc291cmNlTWFwcyA9ICFpc1Byb2R1Y3Rpb24oKSxcbiAgICBtaW5pZmllZCA9IGZhbHNlLFxuICAgIGlnbm9yZSA9IFtdLFxuICAgIHJlZmxlY3RzID0gW10sXG4gICAgZXh0ID0gREVGQVVMVF9FWFQuc3BsaXQoJywnKVxuICB9ID0gb3B0aW9uc1xuXG4gIGxldCBzdG9yZSA9IGFrdlN0YXR1cyhzdGF0dXMpXG4gIHJldHVybiBjbyhmdW5jdGlvbiAqICgpIHtcbiAgICBsZXQgZmlsZW5hbWVzID0geWllbGQgYWdsb2IocGF0dGVybiwgeyBjd2QsIGlnbm9yZSB9KVxuICAgIHJlZmxlY3RzID0geWllbGQgYWdsb2IocmVmbGVjdHMpXG4gICAgZm9yIChsZXQgZmlsZW5hbWUgb2YgZmlsZW5hbWVzKSB7XG4gICAgICBsZXQgc3JjID0gcGF0aC5yZXNvbHZlKGN3ZCwgZmlsZW5hbWUpXG4gICAgICBsZXQgZGVzdCA9IHBhdGgucmVzb2x2ZShvdXQsIGV4dC5yZWR1Y2UoKGZpbGVuYW1lLCBleHQpID0+IHJlcGxhY2VFeHQoZmlsZW5hbWUsIGV4dCwgJy5qcycpLCBmaWxlbmFtZSkpXG4gICAgICBpZiAoIWlzUHJvZHVjdGlvbigpKSB7XG4gICAgICAgIGxldCBjaGFuZ2VkID0geWllbGQgc3RvcmUuZmlsdGVyU3RhdHVzVW5rbm93bihbIHNyYywgZGVzdCwgLi4ucmVmbGVjdHMgXSlcbiAgICAgICAgaWYgKGNoYW5nZWQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgbGV0IHNyY010aW1lID0geWllbGQgbXRpbWUoc3JjKVxuICAgICAgICAgIGxldCBkZXN0TXRpbWUgPSB5aWVsZCBtdGltZShkZXN0KVxuICAgICAgICAgIGxldCBza2lwID0gc3JjTXRpbWUgJiYgZGVzdE10aW1lICYmIChzcmNNdGltZSA8PSBkZXN0TXRpbWUpXG4gICAgICAgICAgaWYgKHNraXApIHtcbiAgICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBsZXQgeyBjb2RlLCBtYXAsIGFzdCB9ID0geWllbGQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBsZXQgb3B0aW9ucyA9IHtcbiAgICAgICAgICBwcmVzZXRzLFxuICAgICAgICAgIG1pbmlmaWVkLFxuICAgICAgICAgIHNvdXJjZU1hcHMsXG4gICAgICAgICAgY29tcGFjdDogZmFsc2UsXG4gICAgICAgICAgYmFiZWxyYzogZmFsc2UsXG4gICAgICAgICAgc291cmNlUm9vdDogcGF0aC5yZWxhdGl2ZShwcm9jZXNzLmN3ZCgpLCBjd2QpLFxuICAgICAgICAgIHBsdWdpbnM6IFsgJ3RyYW5zZm9ybS1ydW50aW1lJyBdXG4gICAgICAgIH1cbiAgICAgICAgdHJhbnNmb3JtRmlsZShzcmMsIG9wdGlvbnMsIChlcnIsIHJlc3VsdCkgPT4gZXJyID8gcmVqZWN0KGVycikgOiByZXNvbHZlKHJlc3VsdCkpXG4gICAgICB9KVxuICAgICAgdHJ5IHtcbiAgICAgICAgaWYgKGRlc3QgIT09IHNyYykge1xuICAgICAgICAgIHlpZWxkIGZpbGVkZWwoZGVzdClcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIC8vIERvIG5vdGhpbmdcbiAgICAgIH1cbiAgICAgIGxldCB7IHNraXBwZWQgfSA9IHlpZWxkIHdyaXRlb3V0KGRlc3QsIGAke2NvZGV9XFxuJHtjb252ZXJ0U291cmNlTWFwLmZyb21PYmplY3QobWFwKS50b0NvbW1lbnQoKX1gLCB7XG4gICAgICAgIG1rZGlycDogdHJ1ZSxcbiAgICAgICAgc2tpcElmSWRlbnRpY2FsOiB0cnVlXG4gICAgICB9KVxuICAgICAgaWYgKCFza2lwcGVkKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGBGaWxlIGdlbmVyYXRlZDogJHtyZWxhdGl2ZShkZXN0KX1gKVxuICAgICAgfVxuXG4gICAgICB5aWVsZCBzdG9yZS5zYXZlU3RhdHVzKFsgc3JjLCBkZXN0LCAuLi5yZWZsZWN0cyBdKVxuICAgIH1cbiAgfSkuY2F0Y2goKGVycikgPT4gY28oZnVuY3Rpb24gKiAoKSB7XG4gICAgeWllbGQgc3RvcmUuZGVzdHJveSgpXG4gICAgdGhyb3cgZXJyXG4gIH0pKVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGFiYWJlbFxuIl19