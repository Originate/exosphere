{"version":3,"sources":["cookies.js"],"names":[],"mappings":"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","file":"cookies.js","sourcesContent":["// See [RFC 2109](http://tools.ietf.org/html/rfc2109.html) and\n// [document.cookie](http://dev/loper.mozilla.org/en/document.cookie)\nconst DOM         = require('./dom');\nconst { isArray } = require('util');\nconst Tough       = require('tough-cookie');\nconst { Cookie }  = Tough;\n\n\n// Lists all available cookies.\nmodule.exports = class Cookies extends Array {\n\n  constructor() {\n    super();\n  }\n\n  // Used to dump state to console (debugging)\n  dump(output = process.stdout) {\n    for (let cookie of this.sort(Tough.cookieCompare))\n      output.write(`${cookie}\\n`);\n  }\n\n  // Serializes all selected cookies into a single string.  Used to generate a cookies header.\n  //\n  // domain - Request hostname\n  // path   - Request pathname\n  serialize(domain, path) {\n    return this\n      .select({ domain: domain, path: path })\n      .map(cookie => cookie.cookieString())\n      .join('; ');\n  }\n\n  // Returns all cookies that match the identifier (name, domain and path).\n  // This is used for retrieving cookies.\n  select(identifier) {\n    let cookies = this.filter(cookie => cookie.TTL() > 0); // eslint-disable-line new-cap\n    if (identifier.name)\n      cookies = cookies.filter(cookie => cookie.key === identifier.name);\n    if (identifier.path)\n      cookies = cookies.filter(cookie => Tough.pathMatch(identifier.path, cookie.path));\n    if (identifier.domain)\n      cookies = cookies.filter(cookie => Tough.domainMatch(identifier.domain, cookie.domain));\n    return cookies\n      .sort((a, b)=> b.domain.length - a.domain.length)\n      .sort(Tough.cookieCompare);\n  }\n\n  // Adds a new cookie, updates existing cookie (same name, domain and path), or\n  // deletes a cookie (if expires in the past).\n  set(params) {\n    const cookie = new Cookie({\n      key:    params.name,\n      value:  params.value,\n      domain: params.domain || 'localhost',\n      path:   params.path || '/'\n    });\n    if (params.expires)\n      cookie.setExpires(params.expires);\n    else if (params.hasOwnProperty('max-age'))\n      cookie.setMaxAge(params['max-age']);\n    cookie.secure   = !!params.secure;\n    cookie.httpOnly = !!params.httpOnly;\n\n    // Delete cookie before setting it, so we only store one cookie (per\n    // domain/path/name)\n    this\n      .filter(c   => c.domain === cookie.domain)\n      .filter(c   => c.path === cookie.path)\n      .filter(c   => c.key === cookie.key)\n      .forEach(c  => this.delete(c));\n    if (cookie.TTL() > 0) // eslint-disable-line new-cap\n      this.push(cookie);\n  }\n\n  // Delete the specified cookie.\n  delete(cookie) {\n    const index = this.indexOf(cookie);\n    if (~index)\n      this.splice(index, 1);\n  }\n\n  // Deletes all cookies.\n  deleteAll() {\n    this.length = 0;\n  }\n\n  // Update cookies with HTTP response\n  //\n  // httpHeader - Value of HTTP Set-Cookie header (string/array)\n  // domain     - Set from hostname\n  // path       - Set from pathname\n  update(httpHeader, domain, path) {\n    // One Set-Cookie is a string, multiple is an array\n    const headers = isArray(httpHeader) ? httpHeader : [httpHeader];\n    headers\n      .map(cookie => Cookie.parse(cookie))\n      .filter(cookie => cookie)\n      .forEach(cookie => {\n        cookie.domain = cookie.domain || domain;\n        cookie.path   = cookie.path || Tough.defaultPath(path);\n\n        // Delete cookie before setting it, so we only store one cookie (per\n        // domain/path/name)\n        this\n          .filter(c   => c.domain === cookie.domain)\n          .filter(c   => c.path === cookie.path)\n          .filter(c   => c.key === cookie.key)\n          .forEach(c  => this.delete(c));\n        if (cookie.TTL() > 0) // eslint-disable-line new-cap\n          this.push(cookie);\n      });\n  }\n\n};\n\n\n// Returns name=value pairs\nDOM.HTMLDocument.prototype.__defineGetter__('cookie', function() {\n  const { cookies } = this.defaultView.browser;\n  return cookies\n    .select({ domain: this.location.hostname, path: this.location.pathname })\n    .filter(cookie => !cookie.httpOnly)\n    .map(cookie    => `${cookie.key}=${cookie.value}`)\n    .join('; ');\n});\n\n// Accepts serialized form (same as Set-Cookie header) and updates cookie from\n// new values.\nDOM.HTMLDocument.prototype.__defineSetter__('cookie', function(cookie) {\n  const { cookies } = this.defaultView.browser;\n  cookies.update(cookie.toString(), this.location.hostname, this.location.pathname);\n});\n"]}