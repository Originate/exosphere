{"version":3,"sources":["xhr.js"],"names":[],"mappings":"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","file":"xhr.js","sourcesContent":["// Implements XMLHttpRequest.\n// See http://www.w3.org/TR/XMLHttpRequest/#the-abort()-method\n\n\nconst DOM     = require('./dom');\nconst Fetch   = require('./fetch');\nconst ms      = require('ms');\nconst URL     = require('url');\nconst Utils   = require('jsdom/lib/jsdom/utils');\nconst EventTarget = require('jsdom/lib/jsdom/living/generated/EventTarget');\n\nconst { DOMException } = DOM;\n\n\nclass XMLHttpRequest {\n//class XMLHttpRequest extends EventTarget {\n\n  constructor(window) {\n    //super();\n    EventTarget.setup(this);\n    for (let method in EventTarget.interface.prototype)\n      this[method] = EventTarget.interface.prototype[method];\n\n    this._window      = window;\n    this._browser     = window.browser;\n    // Pending request\n    this._pending     = null;\n    // Response headers\n    this.readyState   = XMLHttpRequest.UNSENT;\n\n    this.onreadystatechange = null;\n    this.timeout      = 0;\n\n    // XHR events need the first to dispatch, the second to propagate up to window\n    this._ownerDocument = window.document;\n  }\n\n\n  // Aborts the request if it has already been sent.\n  abort() {\n    const request = this._pending;\n    const sent    = !!request;\n    if (this.readyState === XMLHttpRequest.UNSENT || (this.readyState === XMLHttpRequest.OPENED && !sent)) {\n      this.readyState = XMLHttpRequest.UNSENT;\n      return;\n    }\n    // Aborting a done request sets its readyState to UNSENT and does not trigger a readystatechange event\n    // https://xhr.spec.whatwg.org/#the-abort()-method\n    if (this.readyState === XMLHttpRequest.DONE) {\n      this.readyState = XMLHttpRequest.UNSENT;\n    } else {\n      // Tell any pending request it has been aborted.\n      request.aborted = true;\n    }\n    this._response  = null;\n    this._error     = null;\n    this._pending   = null;\n  }\n\n\n  // Initializes a request.\n  //\n  // Calling this method an already active request (one for which open()or\n  // openRequest()has already been called) is the equivalent of calling abort().\n  open(method, url, useAsync, user, password) { // jshint ignore:line\n    if (useAsync === false)\n      throw new DOMException(DOMException.NOT_SUPPORTED_ERR, 'Zombie does not support synchronous XHR requests');\n\n    // Abort any pending request.\n    this.abort();\n\n    // Check supported HTTP method\n    this._method = method.toUpperCase();\n    if (/^(CONNECT|TRACE|TRACK)$/.test(this._method))\n      throw new DOMException(DOMException.SECURITY_ERR, 'Unsupported HTTP method');\n    if (!/^(DELETE|GET|HEAD|OPTIONS|POST|PUT)$/.test(this._method))\n      throw new DOMException(DOMException.SYNTAX_ERR, 'Unsupported HTTP method');\n\n    const headers = new Fetch.Headers();\n\n    // Normalize the URL and check security\n    url = URL.parse(Utils.resolveHref(this._window.location.href, url));\n    // Don't consider port if they are standard for http and https\n    if ((url.protocol === 'https:' && url.port === '443') ||\n        (url.protocol === 'http:'  && url.port === '80'))\n      delete url.port;\n\n    if (!/^https?:$/i.test(url.protocol))\n      throw new DOMException(DOMException.NOT_SUPPORTED_ERR, 'Only HTTP/S protocol supported');\n    url.hostname = url.hostname || this._window.location.hostname;\n    url.host = url.port ? `${url.hostname}:${url.port}` : url.hostname;\n    if (url.host !== this._window.location.host) {\n      headers.set('Origin', `${this._window.location.protocol}//${this._window.location.host}`);\n      this._cors = headers.get('Origin');\n    }\n    url.hash = null;\n    if (user)\n      url.auth = `${user}:${password}`;\n    // Used for logging requests\n    this._url       = URL.format(url);\n    this._headers   = headers;\n\n    // Reset response status\n    this._stateChanged(XMLHttpRequest.OPENED);\n  }\n\n\n  // Sets the value of an HTTP request header.You must call setRequestHeader()\n  // after open(), but before send().\n  setRequestHeader(header, value) {\n    if (this.readyState !== XMLHttpRequest.OPENED)\n      throw new DOMException(DOMException.INVALID_STATE_ERR,  'Invalid state');\n    this._headers.set(header, value);\n  }\n\n\n  // Sends the request. If the request is asynchronous (which is the default),\n  // this method returns as soon as the request is sent. If the request is\n  // synchronous, this method doesn't return until the response has arrived.\n  send(data) {\n    // Request must be opened.\n    if (this.readyState !== XMLHttpRequest.OPENED)\n      throw new DOMException(DOMException.INVALID_STATE_ERR,  'Invalid state');\n\n    const request = new Fetch.Request(this._url, {\n      method:   this._method,\n      headers:  this._headers,\n      body:     data\n    });\n    this._pending = request;\n    this._fire('loadstart');\n\n    const timeout = setTimeout(()=> {\n      if (this._pending === request)\n        this._pending = null;\n      request.timedOut = true;\n\n      this._stateChanged(XMLHttpRequest.DONE);\n      this._fire('progress');\n      this._error = new DOMException(DOMException.TIMEOUT_ERR, 'The request timed out');\n      this._fire('timeout', this._error);\n      this._fire('loadend');\n      this._browser.errors.push(this._error);\n    }, this.timeout || ms('2m'));\n\n    this._window._eventQueue.http(request, (error, response)=> {\n      // Request already timed-out, nothing to do\n      if (request.timedOut)\n        return;\n      clearTimeout(timeout);\n\n      if (this._pending === request)\n        this._pending = null;\n\n      // Request aborted\n      if (request.aborted) {\n        this._stateChanged(XMLHttpRequest.DONE);\n        this._fire('progress');\n        this._error = new DOMException(DOMException.ABORT_ERR, 'Request aborted');\n        this._fire('abort', this._error);\n        return;\n      }\n\n      // If not aborted, then we look at networking error\n      if (error) {\n        this._stateChanged(XMLHttpRequest.DONE);\n        this._fire('progress');\n        this._error = new DOMException(DOMException.NETWORK_ERR);\n        this._fire('error', this._error);\n        this._fire('loadend');\n        this._browser.errors.push(this._error);\n        return;\n      }\n\n      // CORS request, check origin, may lead to new error\n      if (this._cors) {\n        const allowedOrigin = response.headers.get('Access-Control-Allow-Origin');\n        if (!(allowedOrigin === '*' || allowedOrigin === this._cors)) {\n          this._error = new DOMException(DOMException.SECURITY_ERR, 'Cannot make request to different domain');\n          this._browser.errors.push(this._error);\n          this._stateChanged(XMLHttpRequest.DONE);\n          this._fire('progress');\n          this._fire('error', this._error);\n          this._fire('loadend');\n          this.raise('error', this._error.message, { exception: this._error });\n          return;\n        }\n      }\n\n      // Store the response so getters have acess access it\n      this._response        = response;\n      // We have a one-stop implementation that goes through all the state\n      // transitions\n      this._stateChanged(XMLHttpRequest.HEADERS_RECEIVED);\n      this._stateChanged(XMLHttpRequest.LOADING);\n\n      const done = this._window._eventQueue.waitForCompletion();\n      response.text().then(text => {\n        this.responseText = text;\n        this._stateChanged(XMLHttpRequest.DONE);\n\n        this._fire('progress');\n        this._fire('load');\n        this._fire('loadend');\n        done();\n      });\n\n\n    });\n    request.sent = true;\n  }\n\n\n  get status() {\n    // Status code/headers available immediately, 0 if request errored\n    return this._response ? this._response.status :\n           this._error    ? 0 : null;\n  }\n\n  get statusText() {\n    // Status code/headers available immediately, '' if request errored\n    return this._response ? this._response.statusText :\n           this._error    ? '' : null;\n  }\n\n  get responseXML() {\n    // Not implemented yet\n    return null;\n  }\n\n  getResponseHeader(name) {\n    // Returns the string containing the text of the specified header, or null if\n    // either the response has not yet been received or the header doesn't exist in\n    // the response.\n    return this._response && this._response.headers.get(name) || null;\n  }\n\n  getAllResponseHeaders() {\n    // Returns all the response headers as a string, or null if no response has\n    // been received. Note: For multipart requests, this returns the headers from\n    // the current part of the request, not from the original channel.\n    if (this._response)\n      // XHR's getAllResponseHeaders, against all reason, returns a multi-line\n      // string.  See http://www.w3.org/TR/XMLHttpRequest/#the-getallresponseheaders-method\n      return this._response.headers.toString();\n    else\n      return null;\n  }\n\n\n  // Fire onreadystatechange event\n  _stateChanged(newState) {\n    this.readyState = newState;\n    this._fire('readystatechange');\n  }\n\n  // Fire the named event on this object\n  _fire(eventName, error) {\n    const event = new DOM.Event('xhr');\n    event.initEvent(eventName, true, true);\n    event.error = error;\n    this.dispatchEvent(event);\n    this._browser.emit('xhr', eventName, this._url);\n  }\n\n  // Raise error coming from jsdom\n  raise(type, message, data) {\n    this._ownerDocument.raise(type, message, data);\n  }\n\n}\n\n\n// Lifecycle states\nXMLHttpRequest.UNSENT           = 0;\nXMLHttpRequest.OPENED           = 1;\nXMLHttpRequest.HEADERS_RECEIVED = 2;\nXMLHttpRequest.LOADING          = 3;\nXMLHttpRequest.DONE             = 4;\n\nmodule.exports = XMLHttpRequest;\n\n"]}