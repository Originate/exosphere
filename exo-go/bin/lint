#!/usr/bin/env bash
set -e

if [ "$(find ../vendor -type d -name 'vendor' | wc -l | tr  -d ' ')" != "1" ]; then
  echo "Nested vendor folders exist. Run 'glide update --strip-vendor' from the root."
  exit 1
fi

if [ -n "$(goimports -l . 2>&1 | grep -v src/terraform/bindata.go)" ]; then
  echo "Code is not formatted. Run 'goimports -w .'"
  goimports -l . 2>&1 | grep -v src/terraform/bindata.go
  exit 1
fi

# required by gotype to work properly
# see https://github.com/golang/go/issues/12703#issuecomment-144429128
go install ./...
gometalinter.v1 --config="lint-config.json" --deadline 60s ./...
